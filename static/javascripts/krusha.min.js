function updateOffset(){var a=episodes_element.outerHeight()-seasons_element.outerHeight(),b=$(this).scrollTop();0>a?(seasons_element.removeClass("seasons-static"),seasons_element.removeClass("seasons-fixed"),seasons_element.addClass("seasons-relative")):a>b?(seasons_element.addClass("seasons-fixed"),seasons_element.removeClass("seasons-static"),seasons_element.removeClass("seasons-relative")):(seasons_element.addClass("seasons-static"),seasons_element.removeClass("seasons-fixed"),seasons_element.removeClass("seasons-relative"))}!function(){angular.module("growlNotifications.config",[]).value("growlNotifications.config",{debug:!0}),angular.module("growlNotifications.directives",[]),angular.module("growlNotifications.filters",[]),angular.module("growlNotifications.services",[]),angular.module("growlNotifications",["growlNotifications.config","growlNotifications.directives","growlNotifications.filters","growlNotifications.services"])}(),function(){function a(a,c,d){var e={ttl:a.options.ttl||5e3};return{restrict:"AE",scope:!0,controller:b,controllerAs:"$growlNotification",link:function(b,f,g,h){var i=angular.extend({},e,b.$eval(g.growlNotificationOptions));g.ttl&&(i.ttl=b.$eval(g.ttl)),c.move(f,a.element),h.timer=d(function(){c.leave(f)},i.ttl)}}}function b(a,b){this.timer=null,this.remove=function(){b.leave(a),this.timer&&this.timer.cancel&&this.timer.cancel()}}a.$inject=["growlNotifications","$animate","$timeout"],b.$inject=["$element","$animate"],angular.module("growlNotifications.directives").directive("growlNotification",a)}(),function(){function a(a){return{restrict:"AE",link:function(b,c){a.element=c}}}a.$inject=["growlNotifications"],angular.module("growlNotifications.directives").directive("growlNotifications",a)}(),function(){function a(){var a={ttl:5e3};this.setOptions=function(b){return angular.extend(a,b),this},this.ttl=function(b){return angular.isDefined(b)?(a.ttl=b,this):a.ttl},this.$get=function(){function b(){this.options=a,this.element=null}return new b}}angular.module("growlNotifications.services").provider("growlNotifications",a)}(),Array.prototype.find||(Array.prototype.find=function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return b;return void 0}),Array.prototype.findIndex||(Array.prototype.findIndex=function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return f;return-1});var onloadCallback=function(){grecaptcha.render("recaptcha",{sitekey:"6Lf3Pf8SAAAAADPdiYyjbvd9dHLxY8ZvxJDwKGxY"})},krusha=angular.module("krushaTV",["ngRoute","ngAnimate","ngCookies","ngSanitize","ui.bootstrap","growlNotifications","ngClipboard","cfp.hotkeys"]);krusha.config(["$routeProvider","$httpProvider","$compileProvider","$locationProvider","$tooltipProvider","ngClipProvider","hotkeysProvider",function(a,b,c,d,e,f,g){a.when("/",{templateUrl:"/static/templates/today.html",controller:"todayCtrl"}).when("/search",{templateUrl:"/static/templates/search.html",controller:"searchCtrl"}).when("/show/:id",{templateUrl:"/static/templates/show.html",controller:"showCtrl"}).when("/login",{templateUrl:"/static/templates/login.html",controller:"loginCtrl"}).when("/signup",{templateUrl:"/static/templates/signup.html",controller:"signupCtrl"}).when("/track",{templateUrl:"/static/templates/track.html",controller:"trackCtrl"}).when("/admin/reddit",{templateUrl:"/static/templates/admin/reddit.html",controller:"redditCtrl"}).when("/admin/imdb",{templateUrl:"/static/templates/admin/imdb.html",controller:"imdbCtrl"}).when("/profile",{templateUrl:"/static/templates/profile.html",controller:"profileCtrl"}).when("/unwatched",{templateUrl:"/static/templates/unwatched.html",controller:"unwatchedCtrl"}).when("/watched",{templateUrl:"/static/templates/watched.html",controller:"watchedCtrl"}).when("/calendar",{templateUrl:"/static/templates/calendar.html",controller:"calendarCtrl"}).otherwise({redirectTo:"/"}),b.interceptors.push("interceptor"),c.debugInfoEnabled(!1),d.html5Mode(!0),e.setTriggers({slideStartEvent:"slideStopEvent"}),f.setPath("/static/javascripts/bower_components/zeroclipboard/dist/ZeroClipboard.swf"),g.cheatSheetHotkey="h"}]),krusha.controller("navCtrl",["$location","hotkeys",function(a,b){b.add({combo:"m",description:"Look at the episodes of today",callback:function(){a.path("/")}}),b.add({combo:"t",description:"Go to your tracked shows",callback:function(){a.path("/track")}}),b.add({combo:"u",description:"Go to your unwatched episodes",callback:function(){a.path("/unwatched")}}),b.add({combo:"w",description:"Go to your watched episodes",callback:function(){a.path("/watched")}}),b.add({combo:"p",description:"Go to profile",callback:function(){a.path("/profile")}}),b.add({combo:"s",description:"Search shows",action:"keyup",callback:function(){var b=$("#navbar_search");b.is(":visible")?b.focus():a.path("/search")}})}]),krusha.controller("parentCtrl",["$scope",function(a){a.title=""}]),krusha.filter("orderByName",["$filter",function(a){var b=/(?:^the )?(.*)/i,c="name",d=function(a){return a[c].match(b)[1]};return function(b,e){return c="undefined"!=typeof e?e:"name",a("orderBy")(b,d)}}]),krusha.filter("formatEpisode",function(){var a=function(a){return a=parseInt(a),10>a?"0"+a.toString():isNaN(a)?"00":a.toString()};return function(b,c){return b=a(b),c=a(c),"S"+c+"E"+b}}),krusha.filter("copyEpisode",["$filter",function(a){return function(b){return b.showname+" "+a("formatEpisode")(b.episode,b.season)}}]),krusha.filter("monthName",function(){var a=["January","February","March","April","May","June","July","August","September","October","November","December"];return function(b){return 1>b||b>12?null:a[b-1]}});var reddit_regex=/^(?:http(?:s)?:\/\/)?(?:www\.)?(?:reddit\.com)?(\/r\/\w+)(?:[.?&/]{1}.*)?$/i,imdb_regex=/^(?:https?:\/\/)?(?:www.)?(?:imdb.com\/title\/)?(tt\d{7})(?:\/.*)?$/i;krusha.directive("subreddit",function(){return{require:"ngModel",link:function(a,b,c,d){d.$validators.subreddit=function(a,b){return d.$isEmpty(a)?!0:reddit_regex.test(b)?!0:!1}}}}),krusha.directive("imdb",function(){return{require:"ngModel",link:function(a,b,c,d){d.$validators.imdb=function(a,b){return d.$isEmpty(a)?!0:imdb_regex.test(b)?!0:!1}}}}),krusha.animation(".fadeSuccess",function(){return{addClass:function(a,b,c){$(a).fadeIn(100,"linear",c)},removeClass:function(a,b,c){$(a).fadeOut(400,"linear",c)}}}),krusha.directive("calendar",["calendar","hotkeys","loggedin",function(a,b,c){var d=function(d){var e=new Date;d.date_format=c.getDateFormat(),d.$on("loggedin",function(){d.date_format=c.getDateFormat()}),d.active_mode="week",d.year=e.getFullYear(),d.month=e.getMonth()+1,d.allMonth=a.getAllMonth(),d.allYears=a.getAllYears(),d.allWeekdays=null,d.dt=new Date;var f=function(a,b){for(var c in b)if(b.hasOwnProperty(c))for(var d in a)if(a.hasOwnProperty(d)){var e=a[d].date,f=new Date(b[c].airdate);if(e.getFullYear()===f.getFullYear()&&e.getMonth()===f.getMonth()&&e.getDate()===f.getDate()){a[d].shows.push(b[c]);break}}};d.open=function(a){a.preventDefault(),a.stopPropagation(),d.opened=!0},d.changeMonth=function(b,c){if(d.allWeekdays=a.allWeekdays,"undefined"==typeof b||"undefined"==typeof c){var e=new Date;b=e.getFullYear(),c=e.getMonth()+1}var g=a.getDays(b,c);d.getShowsMonth()(b,c).success(function(a){f(g,a.episodes),d.days=g})},d.monthBack=function(){d.month=1===d.month?12:d.month-1,12===d.month&&d.year--,d.changeMonth(d.year,d.month)},d.monthForward=function(){d.month=12===d.month?1:d.month+1,1===d.month&&d.year++,d.changeMonth(d.year,d.month)},d.changeWeek=function(b,c,e){if(d.allWeekdays=a.allWeekdays,"undefined"==typeof b||"undefined"==typeof c||"undefined"==typeof e){var g=new Date;b=g.getFullYear(),c=g.getMonth()+1,e=g.getDate()}d.getShowsWeek()(b,c,e).success(function(b){d.first_day=new Date(b.span.frame.from),d.last_day=new Date(b.span.frame.to);var c=a.getDaysWeek(d.first_day,d.last_day);f(c,b.episodes),d.days=c})},d.changeDayDisplay=function(b,c,e){if("undefined"==typeof b||"undefined"==typeof c||"undefined"==typeof e){var g=new Date;b=g.getFullYear(),c=g.getMonth()+1,e=g.getDate()}var h=new Date(b,c-1,e);d.allWeekdays=[a.getWeekDay(h.getDay())],d.getShowsDay()(b,c,e).success(function(b){d.thisDay=new Date(b.span.date);var c=a.getDaysDay(d.thisDay);f(c,b.episodes),d.days=c})},d.changeToDay=function(a,b,c){d.active_mode="day",g(),d.dt=new Date(a,b-1,c),d.changeDayDisplay(a,b,c)},d.changeDay=function(a){d.dt=new Date(d.dt.setDate(d.dt.getDate()+a)),"week"===d.active_mode?d.changeWeek(d.dt.getFullYear(),d.dt.getMonth()+1,d.dt.getDate()):d.changeDayDisplay(d.dt.getFullYear(),d.dt.getMonth()+1,d.dt.getDate())},d.changeDate=function(a){var b=a.getFullYear(),c=a.getMonth()+1,e=a.getDate();"week"===d.active_mode?d.changeWeek(b,c,e):d.changeDayDisplay(b,c,e)},d.changeMode=function(a){var b=new Date,c=d.active_mode;d.active_mode=a,g(),"month"!==a?("month"===c&&(d.dt="undefined"==typeof d.year||"undefined"==typeof d.month||d.year===b.getFullYear()&&d.month===b.getMonth()+1?b:new Date(d.year,d.month-1,1)),"week"===a?d.changeWeek(d.dt.getFullYear(),d.dt.getMonth()+1,d.dt.getDate()):"day"===a&&d.changeDayDisplay(d.dt.getFullYear(),d.dt.getMonth()+1,d.dt.getDate())):("undefined"==typeof d.dt?(d.year=b.getFullYear(),d.month=b.getMonth()+1):(d.year=d.dt.getFullYear(),d.month=d.dt.getMonth()+1),d.changeMonth(d.year,d.month))};var g=function(){switch(b.del("right"),b.del("left"),d.active_mode){case"month":b.bindTo(d).add({combo:"right",description:"go to next month",callback:function(){d.monthForward()}}).add({combo:"left",description:"go to previous month",callback:function(){d.monthBack()}});break;case"day":b.bindTo(d).add({combo:"right",description:"go to next day",callback:function(){d.changeDay(1)}}).add({combo:"left",description:"go to previous day",callback:function(){d.changeDay(-1)}});break;case"week":b.bindTo(d).add({combo:"right",description:"go to next week",callback:function(){d.changeDay(7)}}).add({combo:"left",description:"go to previous week",callback:function(){d.changeDay(-7)}})}};g(),d.changeWeek(d.dt.getFullYear(),d.dt.getMonth()+1,d.dt.getDate())};return{restrict:"E",link:d,templateUrl:"/static/templates/directives/calendar.html",scope:{getShowsMonth:"&",getShowsWeek:"&",getShowsDay:"&"}}}]),krusha.directive("dates",["$filter","calendar",function(a,b){var c=function(c,d,e){if("undefined"!=typeof d){var f=$("<td/>"),g=$("<div/>");g.addClass("date").text(d.date.getDate()).on("click",function(){e()(d.date.getFullYear(),d.date.getMonth()+1,d.date.getDate())}).appendTo(f),$("<span/>").text(b.getWeekDay(d.date.getDay())).appendTo(g);var h=$("<ul/>").addClass("list-unstyled").appendTo(f),i=a("orderByName")(d.shows);i.forEach(function(b){var c=$("<li/>").appendTo(h);$("<a/>").attr("href","/show/"+b.id).text(b.name).appendTo(c),$("<span/>").text(" - "+a("formatEpisode")(b.episode,b.season)).appendTo(c)}),d.active||f.addClass("inactive"),c.append(f)}},d=function(a,b){a.$watch("days",function(){if(b.empty(),"undefined"!=typeof a.days)for(var d=0;d<a.days.length;d+=7){for(var e=$("<tr/>"),f=d;d+7>f;f++)c(e,a.days[f],a.changeToDay);b.append(e)}})};return{restrict:"A",link:d,scope:{days:"=",changeToDay:"&"}}}]),krusha.directive("dailyepisodes",[function(){return{restrict:"E",templateUrl:"/static/templates/directives/dailyepisodes.html",replace:!0}}]),krusha.directive("genreLabels",[function(){var a=function(a,b,c){var d=a.$watch(c.genres,function(b){"undefined"!=typeof b&&(a.genres=b.length>0?b.split(", "):null,d())})};return{restrict:"E",link:a,template:'<span class="label label-default" ng-repeat="genre in ::genres">{{ ::genre }}</span>'}}]),krusha.directive("loadingspinner",["$http",function(a){return{restrict:"E",link:function(b){b.$watch(function(){return a.pendingRequests.length>0},function(a){b.show_spinner=a})},scope:{},template:'<div class="spinner" ng-show="show_spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>'}}]),krusha.directive("loadingcontent",["$http",function(a){return{restrict:"A",link:function(b,c){b.isLoading=function(){return a.pendingRequests.length>0},b.$watch(b.isLoading,function(a){a?c.hide():c.show()})}}}]),krusha.directive("loginButtons",function(){return{restrict:"A",template:'<li><a href="/auth/reddit?keep={{ keep_logged_in }}" class="btn btn-default" target="_self"><i class="fa fa-reddit"></i> Reddit</a></li><li><a href="/auth/google?keep={{ keep_logged_in }}" class="btn btn-danger" target="_self"><i class="fa fa-google"></i> Google</a></li><li><a ng-href="/auth/facebook?keep={{ keep_logged_in }}" class="btn btn-primary" target="_self"><i class="fa fa-facebook"></i> Facebook</a></li>'}}),krusha.directive("scrollTo",function(){var a=function(a,b,c){if(""===c.scrollTo)throw"No target defined";b.on("click",function(){$(document.body).animate({scrollTop:$(c.scrollTo).offset().top-70},200)})};return{restrict:"A",scope:{},link:a}});var seasons_element=null,episodes_element=null;krusha.directive("scrollfix",[function(){var a=function(a,b){seasons_element=b.find("#seasons").first(),episodes_element=b.find("#episodes").first();var c=!0,d=setInterval(function(){c=!0},17),e=function(){c===!0&&(c=!1,updateOffset())};$(window).on("scroll",e),b.on("$destroy",function(){$(window).off("scroll",e),clearInterval(d)})};return{restrict:"A",link:a}}]),krusha.directive("slider",["$timeout",function(a){var b=$("body"),c=function(c,d){function e(){q.bind("mousedown touchstart",g)}function f(){m.is(":visible")?(n=m.width(),o=m.offset().left,r=q.width(),p=o+n-r,c.$watch("model",function(b){l&&a(function(){q.trigger("slideStartEvent")});var d=(n-r)/n,e=(b-c.min)/(c.max-c.min)*100*d;q.css("left",e+"%")})):a(f,100)}function g(d){d.preventDefault(),l=!0,a(function(){q.trigger("slideStartEvent")}),q.addClass("active"),"undefined"!=typeof c.onSlideStart&&c.onSlideStart(),b.bind("mouseup touchend",h),b.bind("mousemove",i),b.bind("touchmove",j)}function h(d){d.preventDefault(),l=!1,a(function(){q.trigger("slideStopEvent")}),q.removeClass("active"),b.unbind("mouseup touchend",h),b.unbind("mousemove",i),b.unbind("touchmove",j),"undefined"!=typeof c.onSlideStop&&c.onSlideStop()}function i(a){a.preventDefault(),k(a.pageX)}function j(a){a.preventDefault(),k(a.originalEvent.touches[0].pageX)}function k(a){var b=null;b=o>a?0:a>p?n:a-o,c.$apply(function(){var a=parseInt(c.min)+b/n*(parseInt(c.max)-parseInt(c.min));c.model=a-a%c.step})}var l=!1,m=d.find(".bar"),n=null,o=null,p=null,q=d.find(".handle"),r=null;f(),e(d),"undefined"==typeof c.tooltipPlacement&&(c.tooltipPlacement="top")};return{restrict:"E",link:c,scope:{min:"@",max:"@",step:"@",model:"=ngModel",onSlideStart:"&",onSlideStop:"&",tooltipPlacement:"@"},template:'<div class="bar"><div class="handle" tooltip="{{ model }}" tooltip-placement="{{ ::tooltipPlacement }}" tooltip-trigger="slideStartEvent"></div></div>'}}]),krusha.directive("success",["$timeout","$animate",function(a,b){var c=function(c,d){d.hide();var e=null;c.$watch("successHandler",function(f,g){f!==g&&"not"!==f&&(a.cancel(e),b.addClass(d,"fadeSuccess"),c.success=c.successHandler,c.successHandler="not",e=a(function(){b.removeClass(d,"fadeSuccess")},c.timeout))},!0)};return{restrict:"E",scope:{timeout:"@timeout",successHandler:"=success"},template:"<span ng-class=\"{'text-success fa fa-check': !!success, 'text-danger': !success}\">{{ success === false ? 'Error' : '' }}</span>",link:c}}]),krusha.directive("unwatched",["$timeout","loggedin",function(a,b){var c=function(a){"undefined"==typeof a.shows&&(a.shows=[]),"undefined"==typeof a.seasons&&(a.seasons=[]),a.dateFormat=b.getDateFormat(),a.getActiveShow=function(){return a.shows.find(function(a){return!!a.active})},a.scrollShows=function(){$(document.body).animate({scrollTop:$("#shows").offset().top-70},200)},a.getActiveSeason=function(){return a.seasons.find(function(a){return!!a.active})},a.getSeasonsScroll=function(b){a.getSeasons(b),$(document.body).animate({scrollTop:$("#seasons").offset().top-70},200)},a.getEpisodesScroll=function(b,c){a.getEpisodes(b,c),$(document.body).animate({scrollTop:$("#episodes").offset().top-70},200)},a.watched_text=a.watched?"unwatched":"watched",a.watched_text_inv=a.watched?"watched":"unwatched",a.watched_text_cap=a.watched?"Unwatched":"Watched",a.watched_text_cap_short=a.watched?"Unw.":"W."};return{restrict:"E",templateUrl:"/static/templates/directives/unwatched.html",link:c,scope:{shows:"=shows",seasons:"=seasons",episodes:"=episodes",getSeasons:"=getSeasons",getEpisodes:"=getEpisodes",markEpisodeWatched:"=markEpisodeWatched",markSeasonWatched:"=markSeasonWatched",markShowWatched:"=markShowWatched",watched:"=watched"}}}]),krusha.factory("calendar",[function(){var a=function(a,b){var c=new Date(a,b,0);return c.getDate()},b=function(b,c){var d=new Date;("undefined"==typeof b||"undefined"==typeof c)&&(b=d.getFullYear(),c=d.getMonth()+1);var e=a(b,c),f=new Date(b,c-1,1),g=[];if(1!==f.getDay()){for(var h=0;h>-7;h--){var i=new Date(b,c-1,h);if(g.push({date:i,active:!1,shows:[]}),1===i.getDay())break}g=g.reverse()}for(var j=1;;){var k=new Date(b,c-1,j),l=!0;if(j>e&&(l=!1),g.push({date:k,active:l,shows:[]}),j>=e&&0===k.getDay())break;j++}return g},c=function(a,b){for(var c=[],d=new Date(a);b>=d;d.setDate(d.getDate()+1))c.push({date:new Date(d),active:!0,shows:[]});return c},d=function(a){var b=[];return b.push({date:new Date(a),active:!0,shows:[]}),b},e=function(){for(var a=[],b=1;12>=b;b++)a.push(b);return a},f=function(){for(var a=[],b=(new Date).getFullYear()+1,c=b;c>=1950;c--)a.push(c);return a},g=function(a){return a-=1,0>a&&(a=6),h[a]},h=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];return{getAllMonth:e,getAllYears:f,allWeekdays:h,getDays:b,getDaysWeek:c,getWeekDay:g,getDaysDay:d}}]),krusha.service("search_text",[function(){var a=null;return{getText:function(){return a},setText:function(b){a=b}}}]),krusha.factory("redirect",["$location",function(a){var b=null;return{login:function(){b=a.path(),a.path("/login")},back:function(){a.path(null!=b&&"/login"!=b?b:"/")}}}]),krusha.factory("interceptor",["$q","loggedin","redirect","notifications",function(a,b,c,d){var e=null,f=null;return{response:function(a){return a},responseError:function(g){if(401===g.status)b.setStatus(!1),"login"in g.data||c.login();else if(429===g.status){if(null===e||e<Date.parse(g.data.error.nextValidRequestDate)||f+5e3<Date.now()){e=Date.parse(g.data.error.nextValidRequestDate);var h=Math.floor((e-Date.now())/1e3),i=Math.floor(h/60),j=h-60*i,k="You made to many requests. You can make the next request in ";k+=i>0?i+" minutes and ":"",k+=j+" seconds.",f=Date.now(),d.add(k,"danger",5e3,!0)}}else 503===g.status&&d.add(g.data.message,"danger",2e4,!0);return a.reject(g)}}}]),krusha.factory("loggedin",["$rootScope",function(a){var b=!1,c=null,d="yyyy-MM-dd";return{getStatus:function(){return b},setStatus:function(c){b=c,a.$broadcast("loggedin")},setUser:function(a){c=a},getUser:function(){return c},getDateFormat:function(){return d},setDateFormat:function(a){d=a?a:"yyyy-MM-dd"}}}]),krusha.factory("notifications",["$rootScope",function(a){var b=[];return{add:function(c,d,e,f,g){"undefined"==typeof f&&(f=!1),"undefined"==typeof g&&(g=!1),b.push({message:c,"class":d,ttl:e,close:f,link:g}),a.$broadcast("notification")},pop:function(){var a=b;return b=[],a}}}]),krusha.factory("apiAuth",["$http",function(a){return{login:function(b,c,d){return"undefined"==typeof d&&(d=!1),a.post("/api/login",{username:b,password:c,keep_logged_in:d})},logout:function(){return a.get("/api/logout")},signup:function(b,c,d){return a.post("/api/signup",{username:b,password:c,captcha:d})},loginStatus:function(){return a.get("/api/status")}}}]),krusha.factory("apiImdb",["$http",function(a){return{submitIMDbId:function(b,c){return a.post("/api/imdb",{imdb_id:b,showid:c})},getSubmittedIMDbIds:function(){return a.get("/api/admin/imdb")},acceptSubmittedIMDbID:function(b){return a.put("/api/admin/imdb/"+b)}}}]),krusha.factory("apiReddit",["$http",function(a){return{subreddit:function(b){return a.get("//www.reddit.com"+b+"/hot.json?limit=5")},reddit5more:function(b,c){return a.get("//www.reddit.com"+b+"/hot.json?limit=5&after="+c)},submitSubreddit:function(b,c){return a.post("/api/subreddit",{subreddit:b,showid:c})},getSubmittedSubreddits:function(){return a.get("/api/admin/subreddit")},acceptSubmittedSubreddit:function(b){return a.put("/api/admin/subreddit/"+b)}}}]),krusha.factory("apiSearch",["$http","$q","loggedin",function(a,b,c){return{searchLocal:function(d){var e=!c.getStatus();return d=d.trim(),d.length>=2?a.get("/api/search/"+d,{cache:e}).then(function(a){return a},function(a){return b(function(b,c){return c(a)})}):b(function(a,b){return b({type:"error",code:400,message:"Search query is too short."})})},searchRemote:function(c){return c=c.trim(),c.length>=3?a.get("/api/search/"+c+"/remote",{cache:!0,timeout:12e4}).then(function(a){return a},function(a){return b(function(b,c){return c(a)})}):b(function(a,b){return b({type:"error",code:400,message:"Search query is too short."})})}}}]),krusha.factory("apiSettings",["$http",function(a){return{setEpisodeOffset:function(b,c){return a.put("/api/profile/settings/episode-offset",{offset:{days:b,hours:c}})},getProfile:function(){return a.get("/api/profile")},setDateFormat:function(b){return a.put("/api/profile/settings/date-format",{date_format:b})}}}]),krusha.factory("apiShow",["$http",function(a){return{addShow:function(b){return a.post("/api/show/",{showid:b},{timeout:12e4})},getShow:function(b){return a.get("/api/show/"+b)},getSeasons:function(b){return a.get("/api/show/"+b+"/season")},getEpisodes:function(b,c){return a.get("/api/show/"+b+"/season/"+c+"/episodes")},getTracked:function(){return a.get("/api/track")},addTracked:function(b){return a.post("/api/track",{showid:b})},deleteTracked:function(b){return a["delete"]("/api/track/"+b)},watchedEpisode:function(b){return a.post("/api/watched/episode",{episodeid:b})},notWatchedEpisode:function(b){return a["delete"]("/api/watched/episode/"+b)},getUnwatched:function(){return a.get("/api/unwatched")},getWatched:function(){return a.get("/api/watched")},markSeasonWatched:function(b,c){return a.post("/api/watched/season",{showid:b,season_nr:c})},markShowWatched:function(b){return a.post("/api/watched/show",{showid:b})},markShowNotWatched:function(b){return a["delete"]("/api/watched/show/"+b)},markSeasonNotWatched:function(b,c){return a["delete"]("/api/watched/season/"+b+"/"+c)},getTodaysEpisodes:function(){return a.get("/api/today")},getomdb:function(b){return a.get("/api/omdb/"+b)},getUnwatchedShows:function(){return a.get("/api/unwatched/shows")},getUnwatchedSeasons:function(b){return a.get("/api/unwatched/shows/"+b+"/seasons")},getUnwatchedEpisodes:function(b,c){return a.get("/api/unwatched/shows/"+b+"/seasons/"+c+"/episodes")},getWatchedShows:function(){return a.get("/api/watched/shows")},getWatchedSeasons:function(b){return a.get("/api/watched/shows/"+b+"/seasons")},getWatchedEpisodes:function(b,c){return a.get("/api/watched/shows/"+b+"/seasons/"+c+"/episodes")},getEpisodesMonth:function(b,c){return a.get("/api/calendar/"+c+"/"+b)},getEpisodesWeek:function(b,c,d){return a.get("/api/calendar/"+d+"/"+c+"/"+b+"/week")},getEpisodesDay:function(b,c,d){return a.get("/api/calendar/"+d+"/"+c+"/"+b)}}}]),krusha.controller("calendarCtrl",["$scope","apiShow",function(a,b){a.$parent.title="Calendar",a.getShowsMonth=function(a,c){return b.getEpisodesMonth(c,a)},a.getShowsWeek=function(a,c,d){return b.getEpisodesWeek(d,c,a)},a.getShowsDay=function(a,c,d){return b.getEpisodesDay(d,c,a)}}]),krusha.controller("loginCtrl",["$scope","$location","apiAuth","notifications","redirect","loggedin",function(a,b,c,d,e,f){a.$parent.title="Login",a.keep_logged_in=!1,a.alerts=[];var g=function(){c.loginStatus().success(function(){b.path("/")})};a.closeAlert=function(b){a.alerts.splice(b,1)},a.login_full=function(b,g,h){c.login(b,g,h).success(function(a){d.add("Welcome "+a.user+"!","success",5e3),f.setUser(a.user),f.setStatus(!0),f.setDateFormat(a.dateFormat),e.back()}).error(function(b,c){401===c&&a.alerts.push({type:"danger",msg:b.message})})},g()}]),krusha.controller("navLoginCtrl",["$scope","$location","$modal","redirect","apiAuth","loggedin","notifications",function(a,b,c,d,e,f,g){a.loggedin=!1,a.user={name:null,id:null};var h=function(){e.loginStatus().success(function(a){f.setUser(a.user),f.setDateFormat(a.dateFormat),f.setStatus(!0)}).error(function(a,b){401==b&&f.setStatus(!1)})};a.loginButton=function(){d.login()},a.$on("loggedin",function(){a.loggedin=f.getStatus(),a.user.name=f.getUser()}),a.open=function(){c.open({templateUrl:"static/templates/loginmodal.html",size:"lg",controller:"ModalInstanceCtrl"})},a.logout=function(){e.logout().success(function(){g.add("Logout successful!","warning",5e3),f.setStatus(!1),f.setDateFormat(!1),b.path("/")}).error(function(){g.add("Logout failed!","danger",5e3)})},h()}]),krusha.controller("ModalInstanceCtrl",["$scope","$modalInstance","apiAuth","notifications","loggedin",function(a,b,c,d,e){a.alerts=[],a.keep_logged_in=!1,a.cancel=function(){b.dismiss("cancel")},a.login=function(b,g,h){c.login(b,g,h).success(function(b){d.add("Welcome "+b.user+"!","success",5e3),e.setUser(b.user),e.setDateFormat(b.dateFormat),e.setStatus(!0),a.cancel()}).error(function(a,b){401===b&&f(a.message,"danger")})};var f=function(b,c){a.alerts.push({type:c,msg:b})};a.closeAlert=function(b){a.alerts.splice(b,1)}}]),krusha.controller("notificationsCtrl",["$scope","notifications",function(a,b){a.notifications={};var c,d=0;a.$on("notification",function(){b.pop().forEach(function(b){c=d++,a.notifications[c]=b})})}]),krusha.controller("profileCtrl",["$scope","$cookieStore","apiSettings","apiImdb","apiReddit","notifications","loggedin","hotkeys",function(a,b,c,d,e,f,g,h){a.$parent.title="Profile",a.admin=!1,a.setOffsetSuccess={value:"not"},a.changeDateFormatSuccess={value:"not"},a.offsets=[],a.dateFormats={"yyyy-MM-dd":"yyyy-MM-dd (2010-31-12)","dd.MM.yyyy":"dd.MM.yyyy (31.12.2010)","MM/dd/yyyy":"MM/dd/yyyy (12/31/2010)"},a.dateFormat="",a.display={reddit:!0,imdb:!0},"undefined"!=typeof b.get("display")&&(a.display=b.get("display"));var i=["h","m","t","u","w","p","s"],j=new Date;j.setHours(0),j.setMinutes(0),j.setSeconds(0),j.setMilliseconds(0),a.now=j;var k=function(){c.getProfile().success(function(b){a.username=b.user,a.total_shows=b.total_shows,a.total_episodes=b.total_episodes,a.admin=b.admin,a.offset=b.settings.episode_offset,m(a.offset),a.dateFormat=b.settings.date_format}),l()},l=function(){var b=[];for(var c in i)i.hasOwnProperty(c)&&b.push(h.get(i[c]));a.shortcuts=b};a.setOffset=function(b){c.setEpisodeOffset(parseInt(b.days),parseInt(b.hours)).success(function(){a.setOffsetSuccess.value=!0}).error(function(){a.setOffsetSuccess.value=!1})};var m=function(b){if("undefined"!=typeof b){var c=24*b.days+b.hours,d=c%24,e=(c-d)/24;a.days=e,a.hours=d;var f=new Date;f.setHours(0),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0),f.setDate(a.now.getDate()+e),f.setHours(a.now.getHours()+d),a.dateDisplayed=f}};a.$watch("offset",m,!0),a.getIMDbIds=function(){d.getSubmittedIMDbIds().success(function(b){a.imdb_ids=b.imdb_ids}).error(function(b,c){404===c&&(a.imdb_ids=null)})},a.acceptIMDbId=function(b){d.acceptSubmittedIMDbID(b).success(function(){a.getIMDbIds()}).error(function(a,b){409===b&&f.add(a.message,"danger",5e3)})},a.getSubreddits=function(){e.getSubmittedSubreddits().success(function(b){a.subreddits=b.subreddits}).error(function(b,c){404===c&&(a.subreddits=null)})},a.acceptSub=function(b){e.acceptSubmittedSubreddit(b).success(function(){a.getSubreddits()})},a.changeDateFormat=function(b){c.setDateFormat(b).success(function(){a.changeDateFormatSuccess.value=!0,g.setDateFormat(b)})},a.changeDisplaySetting=function(a){b.put("display",a)},k()}]),krusha.controller("mainCtrl",["$scope","$rootScope","$location","search_text",function(a,b,c,d){a.getResults=function(a){d.setText(a),"/search"!==c.path()?c.path("/search"):b.$broadcast("search_input")}}]),krusha.controller("searchCtrl",["$scope","$location","$rootScope","apiSearch","apiShow","search_text",function(a,b,c,d,e,f){a.$parent.title="Search Results",a.shows=[],a.shows_remote=[];var g=function(){var b=f.getText();null!==b&&b.length>=2&&(a.shows=[],a.shows_remote=[],d.searchLocal(b).then(function(b){a.shows=b.data.shows},function(){a.shows=[]}),d.searchRemote(b).then(function(b){a.shows_remote=b.data.shows},function(){a.shows_remote=[]}))},h=function(){var b=a.shows;a.shows_remote.forEach(function(a){var c=!1;for(var d in b)if(b.hasOwnProperty(d)&&b[d].showid===a.showid){c=!0;break}c||b.push(a)}),a.result=b};a.$watch("shows",h),a.$watch("shows_remote",h),a.mobileSearch=function(a){f.setText(a),c.$broadcast("search_input")},a.getShow=function(a){"local"===a.location?b.path("/show/"+a.id):e.addShow(a.showid).success(function(a){b.path("/show/"+a.id)})},a.clearSearch=function(){a.mobSearchText="",$("#mobileSearch").focus()},a.$on("search_input",function(){g()}),g()}]),krusha.controller("showCtrl",["$scope","$routeParams","$cookies","$cookieStore","$timeout","apiShow","apiReddit","apiImdb","notifications","loggedin",function(a,b,c,d,e,f,g,h,i,j){a.show={},a.seasons={},a.tracked=null,a.reddit=[],a.showWatched=!0,a.loggedin=j.getStatus(),a.submittedRedditText=!1,a.submittedImdbId=!1,a.dateFormat=j.getDateFormat(),a.$on("loggedin",function(){a.dateFormat=j.getDateFormat()}),a.active_season=1;var k={};a.dateFormat=j.getDateFormat();var l=new Date;l.setDate(l.getDate()-7);var m=new Date;a.display="undefined"!=typeof d.get("display")?d.get("display"):{reddit:!0,imdb:!0},a.$on("loggedin",function(){a.loggedin=j.getStatus(),q(v),a.getEpisodes(v,a.active_season),n()});var n=function(){void 0!==c.showWatched&&a.loggedin===!0&&(a.showWatched="true"===c.showWatched)},o=function(b){f.getomdb(b).success(function(b){a.omdb=b})},p=function(b){g.subreddit(b).success(function(c){k.sub=b,k.after=c.data.after,c.data.children.forEach(function(b){a.reddit.push(b)})})};a.nextFive=function(){g.reddit5more(k.sub,k.after).success(function(b){k.after=b.data.after,b.data.children.forEach(function(b){a.reddit.push(b)})})};var q=function(b){f.getShow(b).success(function(b){a.show=b,a.$parent.title=a.show.name,a.tracked="tracked"in b?b.tracked:null,b.subreddit&&a.display.reddit&&p(b.subreddit),b.imdbid&&a.display.imdb&&o(b.imdbid)}).error(function(b,c){404===c&&(a.show.name="Show not found")})},r=function(b,c){f.getSeasons(b).success(function(b){a.seasons=b.seasons,"undefined"==typeof c?c=b.season-1:c--,a.seasons[c].active=!0,a.episodes=b.episodes,s()})};a.getEpisodes=function(b,c){a.active_season=c,f.getEpisodes(b,c).success(function(b){a.episodes=b.episodes,a.seasons.find(function(a){return a.active===!0}).active=!1,a.seasons.find(function(a){return a.season===b.season}).active=!0,s(),u()})},a.SaveShowWatched=function(b){c.showWatched=b,a.showWatched=b,t()},a.lessThanAWeek=function(a){var b=new Date(Date.parse(a));return b>=l&&m>=b},a.track=function(b,c){c?f.deleteTracked(b.id).success(function(){a.tracked=!1,i.add("Removed "+b.name+" from tracked shows.","danger",5e3)}):f.addTracked(b.id).success(function(){a.tracked=!0,i.add("Added "+b.name+" to tracked shows.","success",5e3),r(b.id,a.active_season)})},a.watchedEpisode=function(b){var c=a.seasons.find(function(a){return a.active===!0});b.watched?f.notWatchedEpisode(b.id).success(function(){b.watched=!1,c.watched_count--,t()}):f.watchedEpisode(b.id).success(function(){b.watched=!0,c.watched_count++,t()})},a.submitSubreddit=function(b,c){var d=b.match(reddit_regex);g.submitSubreddit(d[1],c).success(function(){a.submittedRedditText=d[1]})},a.submitIMDB=function(b,c){var d=b.match(imdb_regex);
h.submitIMDbId(d[1],c).success(function(){a.submittedImdbId=d[1]})};var s=function(){e(updateOffset)};a.unwatchedSeasons=function(){if(a.tracked&&a.showWatched===!1){for(var b in a.seasons)if(a.seasons.hasOwnProperty(b)&&a.seasons[b].episode_count>a.seasons[b].watched_count)return!0;return!1}return!0};var t=function(){if(a.showWatched!==!0){for(var b=!1,c=a.active_season-1;c<a.seasons.length;c++)if(a.seasons.hasOwnProperty(c)&&a.seasons[c].episode_count>a.seasons[c].watched_count){b=c;break}if(!b)for(var d=a.active_season-2;d>=0;d--)if(a.seasons.hasOwnProperty(d)&&a.seasons[d].episode_count>a.seasons[d].watched_count){b=d;break}(b>0||0===b)&&a.getEpisodes(a.show.id,b+1)}},u=function(){$(document.body).animate({scrollTop:$("#episodes").offset().top-70},200)},v=b.id;q(v),r(v),n()}]),krusha.controller("signupCtrl",["$scope","$location","apiAuth","notifications","loggedin",function(a,b,c,d,e){a.$parent.title="Sign Up",a.alerts=[];var f=function(){c.loginStatus().success(function(){b.path("/")})};a.closeAlert=function(b){a.alerts.splice(b,1)},a.signup=function(f,g){var h=grecaptcha.getResponse();""===h?a.alerts.push({type:"danger",msg:"You need to complete the captcha."}):c.signup(f,g,h).success(function(a){e.setUser(a.user),e.setStatus(!0),d.add("Welcome "+a.user+"!","success",5e3),b.path("/")}).error(function(b){grecaptcha.reset(),a.alerts.push({type:"danger",msg:b.message})})},f()}]),krusha.controller("todayCtrl",["$scope","$filter","$location","apiShow",function(a,b,c,d){a.$parent.title="New Episodes",a.stopClick=function(a){a.stopPropagation()};var e=function(){d.getTodaysEpisodes().success(function(c){a.todays_episodes=b("filter")(c.episodes,{age:0},!0),a.tomorrows_episodes=b("filter")(c.episodes,{age:-1},!0),a.yesterdays_episodes=b("filter")(c.episodes,{age:1},!0)})};a.changeLocation=function(a){c.path("show/"+a)},e()}]),krusha.controller("trackCtrl",["$scope","apiShow","notifications",function(a,b,c){a.$parent.title="Tracked Shows";var d=function(){b.getTracked().success(function(b){a.shows=b.shows}).error(function(b,c){404===c&&(a.shows=null)})},e=function(a){b.addTracked(a.id).success(function(){d(),c.add("You are now tracking "+a.name+" again.","success",1e4,!0)})};a.doNotTrack=function(d){b.deleteTracked(d.id).success(function(){a.shows.splice(a.shows.indexOf(d),1);var b={link_function:function(){e(d)},text:"Undo"};c.add("Removed "+d.name+" from tracked shows.","danger",1e4,!0,b)})},a.orderByName=function(a){var b=/(?:^the )?(.*)/i;return a.name.match(b)[1]},d()}]),krusha.controller("unwatchedCtrl",["$scope","$filter","apiShow",function(a,b,c){a.$parent.title="Unwatched Episodes",a.watched=!1;var d=function(){c.getUnwatchedShows().success(function(b){a.shows=b.shows,a.shows[0].active=!0,a.seasons=b.seasons,a.seasons[0].active=!0,a.episodes=b.episodes})};a.getUnwatchedSeasons=function(b){c.getUnwatchedSeasons(b).success(function(c){var d=a.shows.find(function(a){return a.id===b});a.shows.forEach(function(a){a.active=!1}),d.active=!0,a.seasons=c.seasons,a.seasons[0].active=!0,a.episodes=c.episodes})},a.getUnwatchedEpisodes=function(b,d){c.getUnwatchedEpisodes(b,d).success(function(b){var c=a.seasons.find(function(a){return a.season===d});a.seasons.forEach(function(a){a.active=!1}),c.active=!0,a.episodes=b.episodes})},a.markEpisodeWatched=function(d){c.watchedEpisode(d.id).success(function(){if(a.episodes.splice(a.episodes.indexOf(d),1),0===a.episodes.length){var c=a.seasons.find(function(a){return!!a.active});a.seasons.splice(a.seasons.indexOf(c),1);var e=a.shows.find(function(a){return!!a.active});a.seasons.length>0?a.getUnwatchedEpisodes(e.id,a.seasons[0].season):(a.shows.splice(a.shows.indexOf(e),1),a.shows.length>0&&a.getUnwatchedSeasons(b("orderByName")(a.shows)[0].id))}})},a.markSeasonWatched=function(){var d=a.seasons.findIndex(function(a){return!!a.active}),e=a.shows.findIndex(function(a){return!!a.active}),f=a.shows[e].id,g=a.seasons[d].season;c.markSeasonWatched(f,g).success(function(){a.seasons.splice(d,1),a.seasons.length>0?a.getUnwatchedEpisodes(f,a.seasons[0].season):(a.shows.splice(e,1),a.shows.length>0&&a.getUnwatchedSeasons(b("orderByName")(a.shows)[0].id))})},a.markShowWatched=function(){var d=a.shows.findIndex(function(a){return!!a.active}),e=a.shows[d].id;c.markShowWatched(e).success(function(){a.shows.splice(d,1),a.shows.length>0&&a.getUnwatchedSeasons(b("orderByName")(a.shows)[0].id)})},d()}]),krusha.controller("watchedCtrl",["$scope","$filter","apiShow",function(a,b,c){a.$parent.title="Watched Episodes",a.watched=!0;var d=function(){c.getWatchedShows().success(function(b){a.shows=b.shows,a.shows[0].active=!0,a.seasons=b.seasons,a.seasons[0].active=!0,a.episodes=b.episodes})};a.getWatchedSeasons=function(b){c.getWatchedSeasons(b).success(function(c){var d=a.shows.find(function(a){return a.id===b});a.shows.forEach(function(a){a.active=!1}),d.active=!0,a.seasons=c.seasons,a.seasons[0].active=!0,a.episodes=c.episodes})},a.getWatchedEpisodes=function(b,d){c.getWatchedEpisodes(b,d).success(function(b){var c=a.seasons.find(function(a){return a.season===d});a.seasons.forEach(function(a){a.active=!1}),c.active=!0,a.episodes=b.episodes})},a.markEpisodeUnwatched=function(d){c.notWatchedEpisode(d.id).success(function(){if(a.episodes.splice(a.episodes.indexOf(d),1),0===a.episodes.length){var c=a.seasons.find(function(a){return!!a.active});a.seasons.splice(a.seasons.indexOf(c),1);var e=a.shows.find(function(a){return!!a.active});a.seasons.length>0?a.getWatchedEpisodes(e.id,a.seasons[0].season):(a.shows.splice(a.shows.indexOf(e),1),a.shows.length>0&&a.getWatchedSeasons(b("orderByName")(a.shows)[0].id))}})},a.markSeasonNotWatched=function(){var d=a.seasons.findIndex(function(a){return!!a.active}),e=a.shows.findIndex(function(a){return!!a.active}),f=a.shows[e].id,g=a.seasons[d].season;c.markSeasonNotWatched(f,g).success(function(){a.seasons.splice(d,1),a.seasons.length>0?a.getWatchedEpisodes(f,a.seasons[0].season):(a.shows.splice(e,1),a.shows.length>0&&a.getWatchedSeasons(b("orderByName")(a.shows)[0].id))})},a.markShowNotWatched=function(){var d=a.shows.findIndex(function(a){return!!a.active}),e=a.shows[d].id;c.markShowNotWatched(e).success(function(){a.shows.splice(d,1),a.shows.length>0&&a.getWatchedSeasons(b("orderByName")(a.shows)[0].id)})},d()}]);
//# sourceMappingURL=krusha.min.js.map